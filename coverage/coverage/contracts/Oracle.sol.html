<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/Oracle.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> Oracle.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">70% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>28/40</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">40% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>4/10</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">55.56% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>5/9</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">68.29% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>28/41</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.6.2;
&nbsp;
import "@chainlink/contracts/src/v0.6/interfaces/AggregatorInterface.sol";
import "@chainlink/contracts/src/v0.6/ChainlinkClient.sol";
import "./Utils.sol";
&nbsp;
contract Oracle is ChainlinkClient {
&nbsp;
    // storage
    struct Pairing {
        string value;
        bool set;
    }
    mapping(address =&gt; Pairing) priceAggregators; // price aggregator contracts mapped to Pairings
    mapping(bytes32 =&gt; address) eventIDs;         // Request IDs mapped to event IDs
    
    // ChainLink data (Kovan network)
    address _token            = 0xa36085F69e2889c224210F603D836748e7dC0088; // ChainLink ERC20
    address _oracle           = 0x2f90A6D021db21e1B2A077c5a37B3C7E75D15b7e; // oracle contract
    string _jobId             =         "a7ab70d561d34eb49e9b1612fd2e044b"; // callback job
&nbsp;
&nbsp;
    // gatekeepers
    function _validPriceAggregator(address _priceAggregator) view internal {
        // require that oracle address is valid
        Pairing memory pairing = priceAggregators[_priceAggregator];
        <span class="missing-if-branch" title="else path not taken" >E</span>require(pairing.set, 
                "Oracle: Invalid Price Aggregator address.");
    }
&nbsp;
    function _hasGrantedAllowance() internal {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(Utils.allowance(tx.origin, address(this), Utils.GetChainLinkAddress()) ==  (1 * LINK), 
                "Oracle: Required LINK amount not granted.");
    }
&nbsp;
&nbsp;
    // constructor
    constructor() public
    {
        <span class="missing-if-branch" title="if path not taken" >I</span>if(Utils.compare(Utils.GetNetwork(), "kovan")) 
<span class="cstat-no" title="statement not covered" >            setPublicChainlinkToken()</span>;
        setPriceAggregators();
    }
&nbsp;
&nbsp;
    // functions
    function setPriceAggregators() private {
        priceAggregators[0x5813A90f826e16dB392abd2aF7966313fc1fd5B8] = Pairing("AUD/USD",   true);
        priceAggregators[0x8e67A0CFfbbF6A346ce87DFe06daE2dc782b3219] = Pairing("BAT/USD",   true);
        priceAggregators[0x8993ED705cdf5e84D0a3B754b5Ee0e1783fcdF16] = Pairing("BNB/USD",   true);
        priceAggregators[0x6135b13325bfC4B00278B4abC5e20bbce2D6580e] = Pairing("BTC/USD",   true);
        priceAggregators[0xed0616BeF04D374969f302a34AE4A63882490A8C] = Pairing("CHF/USD",   true);
        priceAggregators[0x777A68032a88E5A84678A77Af2CD65A7b3c0775a] = Pairing("DAI/USD",   true);
        priceAggregators[0x9326BFA02ADD2366b30bacB125260Af641031331] = Pairing("ETH/USD",   true);
        priceAggregators[0x0c15Ab9A0DB086e062194c273CC79f41597Bbf13] = Pairing("EUR/USD",   true);
        priceAggregators[0x28b0061f44E6A9780224AA61BEc8C3Fcb0d37de9] = Pairing("GBP/USD",   true);
        priceAggregators[0xD627B1eF3AC23F1d3e576FA6206126F3c1Bd0942] = Pairing("JPY/USD",   true);
        priceAggregators[0x396c5E36DD0a0F5a5D33dae44368D4193f69a1F0] = Pairing("LINK/USD",  true);
        priceAggregators[0xCeE03CF92C7fFC1Bad8EAA572d69a4b61b6D4640] = Pairing("LTC/USD",   true);
        priceAggregators[0x48c9FF5bFD7D12e3C511022A6E54fB1c5b8DC3Ea] = Pairing("Oil/USD",   true);
        priceAggregators[0x31f93DA9823d737b7E44bdee0DF389Fe62Fd1AcD] = Pairing("SNX/USD",   true);
        priceAggregators[0x4594051c018Ac096222b5077C3351d523F93a963] = Pairing("XAG/USD",   true);
        priceAggregators[0xc8fb5684f2707C82f28595dEaC017Bfdf44EE9c5] = Pairing("XAU/USD",   true);
        priceAggregators[0x3eA2b7e3ed9EA9120c3d6699240d1ff2184AC8b3] = Pairing("XRP/USD",   true);
        priceAggregators[0xC6F39246494F25BbCb0A8018796890037Cb5980C] = Pairing("XTZ/USD",   true);
        priceAggregators[0x70179FB2F3A0a5b7FfB36a235599De440B0922ea] = Pairing("sDEFI/USD", true);
    }
&nbsp;
    /**
     * Create a new oracle request
     */
    function newRequest(uint256 _until, address _priceAggregator, address _eventId)
        external
        returns (bool)
    {
        _validPriceAggregator(_priceAggregator);
        _hasGrantedAllowance();
&nbsp;
        <span class="missing-if-branch" title="if path not taken" >I</span>if(Utils.compare(Utils.GetNetwork(), "kovan")) {
<span class="cstat-no" title="statement not covered" >            Chainlink.Request memory req = buildChainlinkRequest(</span>
                stringToBytes32(_jobId),
                address(this), 
                this.fullfillRequest.selector
            );
<span class="cstat-no" title="statement not covered" >            req.addUint("until", _until)</span>;
<span class="cstat-no" title="statement not covered" >            bytes32 _requestId = sendChainlinkRequestTo(_oracle, req, 1 * LINK);</span>
<span class="cstat-no" title="statement not covered" >            eventIDs[_requestId] = _eventId</span>;            
        }
        return true;
    }
&nbsp;
    /**
     * Get the latest price at the correct time
     */
<span class="fstat-no" title="function not covered" >    function fullfillRequest(bytes32 _requestId) </span>
        recordChainlinkFulfillment(_requestId)
        public
    {
<span class="cstat-no" title="statement not covered" >        address _event = eventIDs[_requestId];</span>
<span class="cstat-no" title="statement not covered" >        int256 settledPrice = 36560000000;</span> // for tests
<span class="cstat-no" title="statement not covered" >        (bool success, bytes memory result) = Utils.GetOPEventFactoryAddress().call(</span>
            (abi.encodeWithSignature("settle(int256,address)",
            settledPrice, _event)
        ));
<span class="cstat-no" title="statement not covered" >        require(success, "Oracle: call to event contract failed")</span>;
    }
&nbsp;
    /**
     * Get the pairing for the price aggregator
     */
<span class="fstat-no" title="function not covered" >    function getPairing (address _priceAggregator) view external returns(string memory) {</span>
<span class="cstat-no" title="statement not covered" >        _validPriceAggregator(_priceAggregator)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        return priceAggregators[_priceAggregator].value;</span>
    }
&nbsp;
    /**
     * Returns the latest price
     */
<span class="fstat-no" title="function not covered" >    function getLatestPrice(address _priceAggregator) external view returns (int256) {</span>
<span class="cstat-no" title="statement not covered" >        return AggregatorInterface(_priceAggregator).latestAnswer();</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function stringToBytes32(string memory source) internal pure returns (bytes32 result) {    </span>
        assembly {
            result := mload(add(source, 32))
        }
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Oct 02 2020 16:26:48 GMT+0700 (Indochina Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
